openapi: 3.0.3
info:
  title: Sistema de Eventos (Microservices) - API Gateway
  description: |
    Documentação unificada dos microsserviços de Eventos (NexStage).
    
    **Arquitetura**:
    - **API Gateway (Nginx)**: Porta de entrada única (Porta 80).
    - **Auth**: JWT Stateless (Token contém `user_id`, `email`, `roles`).
    - **Rotas Públicas**: Login, Cadastro, Listagem de Eventos, Validação de Certificado.
    - **Rotas Protegidas**: Requerem header `Authorization: Bearer <token>`.
    - **Rotas Admin**: Requerem role `admin`.
  version: 2.1.0
  contact:
    name: Equipe NexStage
servers:
  - url: http://localhost:80
    description: Gateway Local (Docker)
  - url: http://177.44.248.76
    description: Servidor de Produção (VM)

tags:
  - name: Autenticação
    description: Login e gestão de sessão
  - name: Usuários
    description: Gestão de identidade e perfil
  - name: Eventos
    description: Catálogo e gestão de eventos
  - name: Inscrições
    description: Fluxo de participação
  - name: Presenças
    description: Check-in, QR Code e Sincronização Offline
  - name: Certificados
    description: Emissão e validação pública
  - name: Notificações
    description: Disparo de e-mails (Serviço Node.js)

paths:
  # ==========================================
  # SERVIÇO DE USUÁRIOS
  # ==========================================
  /auth:
    post:
      tags: [Autenticação]
      summary: Realizar Login
      description: Autentica usuário e retorna JWT com claims estendidas (id, email, roles).
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                username:
                  type: string
                  default: admin
                password:
                  type: string
                  default: admin
              required: [username, password]
      responses:
        200:
          description: Login realizado com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Token'
        401:
          description: Credenciais inválidas

  /usuarios:
    post:
      tags: [Usuários]
      summary: Criar nova conta (Público)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserCreate'
      responses:
        201:
          description: Usuário criado com sucesso
    get:
      tags: [Usuários]
      summary: Listar todos usuários (Admin)
      security:
        - bearerAuth: []
      responses:
        200:
          description: Lista de usuários
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UserResponse'

  /usuarios/me:
    get:
      tags: [Usuários]
      summary: Perfil do usuário logado
      security:
        - bearerAuth: []
      responses:
        200:
          description: Dados do usuário atual
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
    patch:
      tags: [Usuários]
      summary: Atualizar meus dados
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserUpdate'
      responses:
        200:
          description: Dados atualizados

  /usuarios/{id}:
    get:
      tags: [Usuários]
      summary: Buscar usuário por ID (Admin/Interno)
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Detalhes do usuário

  /usuarios/heartbeat:
    post:
      tags: [Usuários]
      summary: Registrar batimento cardíaco (App Local)
      description: Usado pelo App Local para informar status online/offline para o painel de monitoramento.
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                  enum: [online, working_offline]
      responses:
        204:
          description: Status registrado

  # ==========================================
  # SERVIÇO DE EVENTOS
  # ==========================================
  /eventos:
    get:
      tags: [Eventos]
      summary: Listar eventos disponíveis
      responses:
        200:
          description: Lista de eventos
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Evento'

  /eventos/{id}:
    get:
      tags: [Eventos]
      summary: Detalhes de um evento
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Detalhes do evento
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Evento'

  /admin/eventos:
    post:
      tags: [Eventos]
      summary: Criar Evento (Admin)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EventoCreate'
      responses:
        201:
          description: Evento criado

  /admin/eventos/{id}:
    patch:
      tags: [Eventos]
      summary: Atualizar Evento (Admin)
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EventoUpdate'
      responses:
        200:
          description: Evento atualizado

  # ==========================================
  # INSCRIÇÕES
  # ==========================================
  /inscricoes:
    post:
      tags: [Inscrições]
      summary: Inscrever-se em um evento
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                evento_id:
                  type: integer
      responses:
        201:
          description: Inscrição realizada e e-mail enviado

  /inscricoes/me:
    get:
      tags: [Inscrições]
      summary: Minhas Inscrições
      description: Retorna inscrições e certificados associados.
      security:
        - bearerAuth: []
      responses:
        200:
          description: Lista de inscrições
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/InscricaoDetalhes'

  /inscricoes/{id}/cancelar:
    patch:
      tags: [Inscrições]
      summary: Cancelar Inscrição
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Inscrição cancelada

  /admin/inscricoes:
    get:
      tags: [Inscrições]
      summary: Listar todas as inscrições (Admin)
      security:
        - bearerAuth: []
      responses:
        200:
          description: Lista geral

    post:
      tags: [Inscrições]
      summary: Criar inscrição manual (Admin)
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                evento_id:
                  type: integer
                usuario_id:
                  type: integer
      responses:
        201:
          description: Inscrição criada manualmente

  # ==========================================
  # PRESENÇAS & CHECK-IN
  # ==========================================
  /admin/checkin/generate:
    post:
      tags: [Presenças]
      summary: Gerar Token QR Code (Admin)
      description: Gera um token temporário para check-in via QR Code.
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                evento_id:
                  type: integer
                duracao_minutos:
                  type: integer
                  default: 60
      responses:
        200:
          description: Token e URL gerados
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                  url_publica:
                    type: string

  /checkin-qr/{token_uuid}:
    post:
      tags: [Presenças]
      summary: Realizar Check-in via QR Code
      description: Rota usada pelo participante ao ler o QR Code.
      security:
        - bearerAuth: []
      parameters:
        - name: token_uuid
          in: path
          required: true
          schema:
            type: string
      responses:
        200:
          description: Presença registrada com sucesso
        400:
          description: Token inválido, expirado ou inscrição cancelada

  /admin/presencas/checkin:
    post:
      tags: [Presenças]
      summary: Check-in Manual (Admin)
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                inscricao_id:
                  type: integer
                origem:
                  type: string
                  default: MANUAL_ADMIN
      responses:
        201:
          description: Presença registrada

  /admin/sync/presencas:
    post:
      tags: [Presenças]
      summary: Sincronização Offline (App Local -> Nuvem)
      description: Recebe um lote de presenças coletadas offline.
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SyncPayload'
      responses:
        200:
          description: Lote processado

  /admin/presencas/{id}:
    delete:
      tags: [Presenças]
      summary: Remover presença (Correção)
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Presença removida

  # ==========================================
  # SERVIÇO DE CERTIFICADOS
  # ==========================================
  /certificados/validar/{codigo}:
    get:
      tags: [Certificados]
      summary: Validar Certificado (Público)
      parameters:
        - name: codigo
          in: path
          required: true
          schema:
            type: string
      responses:
        200:
          description: Certificado válido
          content:
            application/json:
              schema:
                type: object
                properties:
                  valido:
                    type: boolean
                  participante:
                    type: string
                  evento:
                    type: string

  # ==========================================
  # SERVIÇO DE NOTIFICAÇÕES (Node.js)
  # ==========================================
  /emails:
    post:
      tags: [Notificações]
      summary: Disparar E-mail
      description: Envia e-mail transacional (Inscrição, Cancelamento, Check-in).
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                tipo:
                  type: string
                  enum: [inscricao, cancelamento, checkin, certificado]
                destinatario:
                  type: string
                  format: email
                nome:
                  type: string
                nome_evento:
                  type: string
      responses:
        202:
          description: Solicitação aceita (processamento assíncrono)

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Token:
      type: object
      properties:
        access_token:
          type: string
        token_type:
          type: string

    UserCreate:
      type: object
      required: [username, password, email, full_name]
      properties:
        username:
          type: string
        password:
          type: string
        email:
          type: string
          format: email
        full_name:
          type: string
        cpf:
          type: string
        telefone:
          type: string

    UserUpdate:
      type: object
      properties:
        full_name:
          type: string
        email:
          type: string
        password:
          type: string

    UserResponse:
      type: object
      properties:
        id:
          type: integer
        username:
          type: string
        email:
          type: string
        is_admin:
          type: boolean
        last_heartbeat:
          type: string
          format: date-time
        connection_status:
          type: string

    Evento:
      type: object
      properties:
        id:
          type: integer
        nome:
          type: string
        descricao:
          type: string
        data_evento:
          type: string
          format: date-time
        local:
          type: string
        capacidade:
          type: integer

    EventoCreate:
      type: object
      required: [nome, data_evento, capacidade]
      properties:
        nome:
          type: string
        descricao:
          type: string
        data_evento:
          type: string
          format: date-time
        local:
          type: string
        capacidade:
          type: integer

    EventoUpdate:
      type: object
      properties:
        nome:
          type: string
        descricao:
          type: string
        data_evento:
          type: string
          format: date-time
        local:
          type: string
        capacidade:
          type: integer

    Inscricao:
      type: object
      properties:
        id:
          type: integer
        evento_id:
          type: integer
        status:
          type: string
          enum: [ativa, cancelada]

    InscricaoDetalhes:
      allOf:
        - $ref: '#/components/schemas/Inscricao'
        - type: object
          properties:
            evento:
              $ref: '#/components/schemas/Evento'
            checkin_realizado:
              type: boolean
            certificado:
              type: object
              properties:
                codigo_unico:
                  type: string

    SyncPayload:
      type: object
      properties:
        presencas:
          type: array
          items:
            type: object
            properties:
              inscricao_id:
                type: integer
              data_checkin:
                type: string
                format: date-time
